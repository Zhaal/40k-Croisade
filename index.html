<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Crusade Tracker</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="container">
        <header>
            <h1>Nexus Crusade Tracker</h1>
            <div class="campaign-controls">
                <button id="export-btn">Exporter la Campagne (JSON)</button>
                <button id="import-btn">Importer la Campagne (JSON)</button>
                <input type="file" id="import-file" accept=".json" style="display: none;">
            </div>
            <p class="storage-warning">
               ⚠️ **Attention :** Toutes les données sont sauvegardées localement dans votre navigateur.
                Utilisez l'export pour créer des sauvegardes !
            </p>
            <div class="management-controls">
                <button id="reset-campaign-btn" class="btn-danger">Explosion du Warp (Réinitialiser)</button>
                <button id="campaign-info-btn" class="btn-secondary">Informations de la campagne</button>
            </div>
        </header>

        <main id="player-list-view">
            <h2>Joueurs de la Campagne</h2>
            <div id="player-list">
                </div>
            <button id="add-player-btn" class="btn-primary">Ajouter un Joueur</button>
        </main>

        <section id="player-detail-view" class="hidden">
            <div class="roster-header">
                <h3>Crusade Force Roster</h3>
                <span>
                    <button id="back-to-system-btn" class="hidden" style="margin-right: 10px;">&larr; Retour au système</button>
                    <button id="back-to-list-btn">&larr; Retour à la liste</button>
                </span>
            </div>
            <div class="player-info-grid">
                <div class="info-box"><strong>Joueur:</strong> <span id="player-name-display"></span></div>
                <div class="info-box"><strong>Faction:</strong> <span id="player-faction-display"></span></div>
                <div class="info-box"><strong>Faction de Croisade:</strong> <input type="text" id="crusade-faction" placeholder="Ex: Imperium"></div>
                <div class="info-box">
                    <strong>Points de Réquisition:</strong>
                    <span id="pr-points" class="stat-value"></span> RP
                    <button class="tally-btn" data-action="decrease-rp">-</button>
                    <button class="tally-btn" data-action="increase-rp">+</button>
                </div>
                <div class="info-box">
                    <strong>Éclats de Sombreroche:</strong>
                    <span id="sombreroche-points" class="stat-value"></span>
                    <button class="tally-btn" data-action="decrease-sombreroche">-</button>
                    <button class="tally-btn" data-action="increase-sombreroche">+</button>
                </div>
                <div class="info-box">
                    <strong>Limite de Ravitaillement:</strong>
                    <input type="number" id="supply-limit" min="0"> PL
                </div>
                <div class="info-box"><strong>Ravitaillement Utilisé:</strong> <span id="supply-used" class="stat-value readonly"></span> PL</div>
                <div class="info-box">
                    <strong>Décompte de Batailles:</strong> <span id="battle-tally" class="stat-value">0</span>
                    (V:<span id="wins">0</span> / D:<span id="losses">0</span>)
                    <div class="battle-tally-controls">
                        <button class="tally-btn" data-action="increase-win">+V</button>
                        <button class="tally-btn" data-action="decrease-win" title="Corriger Victoire">-V</button>
                        <button class="tally-btn" data-action="increase-loss">+D</button>
                        <button class="tally-btn" data-action="decrease-loss" title="Corriger Défaite">-D</button>
                    </div>
                </div>
            </div>

            <hr>

            <h3>Ordre de Bataille</h3>
            <table id="order-of-battle">
                <thead>
                    <tr>
                        <th>Nom de l'Unité</th>
                        <th>Rôle</th>
                        <th>Puissance</th>
                        <th>Points de Croisade</th>
                        <th>XP</th>
                        <th>Rang</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="units-tbody">
                </tbody>
            </table>
            <button id="add-unit-btn" class="btn-primary">Ajouter une Unité</button>

            <hr>

            <h3>Objectifs & Notes</h3>
            <textarea id="goals-notes" rows="4" placeholder="Notez ici les objectifs de croisade, les agendas ou d'autres notes..."></textarea>
        </section>
    </div>

    <div id="player-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="player-modal-title">Ajouter un Joueur</h3>
            <form id="player-form">
                <input type="hidden" id="player-id">
                <label for="player-name-input">Nom du Joueur :</label>
                <input type="text" id="player-name-input" required>
                <label for="player-faction-input">Faction Principale :</label>
                <input type="text" id="player-faction-input">
                <button type="submit" class="btn-primary">Sauvegarder</button>
            </form>
        </div>
    </div>

    <div id="unit-modal" class="modal hidden">
        <div class="modal-content large crusade-card">
            <span class="close-btn">&times;</span>
            <h3 id="unit-modal-title" class="crusade-card-title">Fiche d'Unité de Croisade</h3>
            <form id="unit-form">
                <input type="hidden" id="unit-id">
                <div class="unit-card-header">
                     <div class="form-group">
                        <label for="unit-name">Nom de l'unité :</label>
                        <input type="text" id="unit-name" required>
                    </div>
                </div>
                <div class="unit-card-body">
                    <div class="unit-card-column">
                        <div class="form-group small">
                            <label for="unit-role">Rôle :</label>
                            <select id="unit-role">
                                <option value="Hero Epique">Hero Epique</option>
                                <option value="Personnage">Personnage</option>
                                <option value="Monstre">Monstre</option>
                                <option value="Infantrie">Infantrie</option>
                                <option value="Véhicule">Véhicule</option>
                                <option value="Bête">Bête</option>
                                <option value="Fortification">Fortification</option>
                                <option value="Cavalerie">Cavalerie</option>
                                <option value="Aéronef">Aéronef</option>
                                <option value="Transport">Transport</option>
                                <option value="Marcheur">Marcheur</option>
                                <option value="Titanesque">Titanesque</option>
                                <option value="Nuée">Nuée</option>
                                <option value="Artillerie">Artillerie</option>
                            </select>
                        </div>
                        <div class="form-group small"><label for="unit-power">Puissance :</label><input type="number" id="unit-power" min="0" required></div>
                        <div class="form-group small"><label for="unit-xp">XP :</label><input type="number" id="unit-xp" min="0"></div>
                        <div class="form-group small"><label for="unit-crusade-points">Points de Croisade :</label><input type="number" id="unit-crusade-points" min="0"></div>
                        <div class="form-group small"><strong>Rang:</strong> <span id="unit-rank-display"></span></div>
                        <div class="form-group"><label for="unit-equipment">Équipement :</label><textarea id="unit-equipment" rows="5"></textarea></div>
                        <div class="form-group"><label for="unit-warlord-trait">Trait de Seigneur de Guerre :</label><textarea id="unit-warlord-trait" rows="3"></textarea></div>
                        <div class="form-group"><label for="unit-relic">Relique :</label><textarea id="unit-relic" rows="3"></textarea></div>
                    </div>
                    <div class="unit-card-column">
                        <div class="form-group"><label for="unit-honours">Honneurs de Bataille :</label><textarea id="unit-honours" rows="5"></textarea></div>
                        <div class="form-group"><label for="unit-scars">Cicatrices de Bataille :</label><textarea id="unit-scars" rows="5"></textarea></div>
                        <div class="form-group"><label for="unit-marked-for-glory">Marqué pour la Gloire (unités détruites) :</label><input type="number" id="unit-marked-for-glory" min="0"></div>
                    </div>
                </div>
                <button type="submit" class="btn-primary">Sauvegarder l'Unité</button>
            </form>
        </div>
    </div>

    <div id="world-modal" class="modal hidden">
        <div class="modal-content x-large">
            <span class="close-btn">&times;</span>
            <h3 id="world-modal-title" class="crusade-card-title">Système Planétaire</h3>
            <button id="show-map-btn" class="btn-secondary" style="margin-bottom: 15px;">Voir la Carte Galactique</button>
            <button id="edit-crusade-order-btn" class="btn-primary" style="margin-bottom: 15px;">Éditer l'Ordre de Croisade</button>
            <div id="system-container">
                <button class="explore-arrow" id="explore-up" title="Explorer vers le Nord">↑</button>
                <button class="explore-arrow" id="explore-left" title="Explorer vers l'Ouest">←</button>
                <div id="planetary-system">
                </div>
                <button class="explore-arrow" id="explore-right" title="Explorer vers l'Est">→</button>
                <button class="explore-arrow" id="explore-down" title="Explorer vers le Sud">↓</button>
            </div>
            <div id="planet-legend">
                <h4>Légende des Planètes <span id="colonization-percentage"></span></h4>
                <div class="legend-item"><span class="legend-color" data-type="Monde Mort"></span> Monde Mort</div>
                <div class="legend-item"><span class="legend-color" data-type="Monde Sauvage"></span> Monde Sauvage</div>
                <div class="legend-item"><span class="legend-color" data-type="Agri-monde"></span> Agri-monde</div>
                <div class="legend-item"><span class="legend-color" data-type="Monde Forge"></span> Monde Forge</div>
                <div class="legend-item"><span class="legend-color" data-type="Monde Ruche"></span> Monde Ruche</div>
                <div class="legend-item"><span class="legend-color" data-type="Monde Saint (relique)"></span> Monde Saint (relique)</div>
            </div>
        </div>
    </div>

    <div id="planet-type-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="planet-type-modal-title">Définir le type de la planète</h3>
            <form id="planet-type-form">
                <input type="hidden" id="planet-system-id">
                <input type="hidden" id="planet-index">
                <div class="form-group">
                    <label for="planet-name-input">Nom de la planète:</label>
                    <input type="text" id="planet-name-input">
                </div>
                <div class="form-group">
                    <label for="planet-type-select">Type de Monde :</label>
                    <select id="planet-type-select">
                        <option value="Monde Mort">Monde Mort</option>
                        <option value="Monde Sauvage">Monde Sauvage</option>
                        <option value="Agri-monde">Agri-monde</option>
                        <option value="Monde Forge">Monde Forge</option>
                        <option value="Monde Ruche">Monde Ruche</option>
                        <option value="Monde Saint (relique)">Monde Saint (relique)</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="planet-owner-select">Propriétaire :</label>
                    <select id="planet-owner-select">
                        </select>
                </div>
                <div class="form-group" id="planet-defense-container">
                    <label for="planet-defense-input">Points de Défense (PNJ):</label>
                    <input type="number" id="planet-defense-input" min="0" step="50">
                </div>
                <button type="submit" class="btn-primary">Valider</button>
                <button type="button" id="randomize-planet-btn" class="btn-secondary">Randomiser Planète (2 RP)</button>
                <button type="button" id="halve-defense-btn" class="btn-secondary hidden">Saboter Défenses (1 RP)</button>
            </form>
        </div>
    </div>

    <div id="map-modal" class="modal hidden">
        <div class="modal-content large">
            <span class="close-btn">&times;</span>
            <h3 class="crusade-card-title">Carte Galactique</h3>
            <div class="map-controls">
                <label for="map-player-view-select">Point de vue :</label>
                <select id="map-player-view-select"></select>
            </div>
            <div id="galactic-map-container">
            </div>
        </div>
    </div>

    <div id="info-modal" class="modal hidden">
        <div class="modal-content info-panel">
            <span class="close-btn">&times;</span>
            <h3 class="info-title">Règles de la Croisade Nexus</h3>
            <div class="info-body">
                <h4>Début de Campagne & Nouveaux Joueurs</h4>
                <p>Chaque joueur commence avec son propre système de départ, contenant une planète sécurisée et plusieurs planètes neutres (PNJ) à conquérir. Votre première tâche est de sécuriser entièrement votre système natal.</p>

                <h4>Immunité et Entrée sur la Carte</h4>
                <p>Un nouveau joueur commence dans un système natal isolé, non connecté à la carte galactique principale. Ce système est "non découvrable" et bénéficie d'une immunité totale contre les autres joueurs.</p>
                <p>Pour pouvoir rejoindre la guerre galactique, le joueur doit d'abord prouver sa valeur en unifiant son propre secteur. La condition pour rejoindre la carte est la suivante :</p>
                <ul>
                    <li><b>Contrôle total du système natal :</b> Le joueur doit avoir conquis toutes les planètes de son système de départ.</li>
                </ul>
                <p>Une fois cette condition remplie, le joueur aura la possibilité de connecter son système à la carte, le rendant visible et accessible. Tant que le joueur n'a pas conquis son système, il ne peut être ni découvert, ni attaqué, mais il ne peut pas non plus explorer la galaxie.</p>

                <h4>Exploration & Découverte</h4>
                <p>Pour explorer, vous pouvez effectuer un "saut à l'aveugle" ou "envoyer une sonde" (1 RP).</p>
                <ul>
                    <li><b>Systèmes PNJ :</b> Une sonde révèlera le nom et les détails du système PNJ, vous laissant le choix de créer la connexion ou de garder l'information pour plus tard. Un saut à l'aveugle crée la connexion immédiatement.</li>
                    <li><b>Systèmes de Joueur :</b> Une sonde ne révèlera qu'une "présence de croisade majeure", sans nommer le joueur ou son système. Pour établir une route, <b>les deux joueurs doivent se sonder mutuellement</b>. Une fois le contact mutuel établi, l'un des deux joueurs peut confirmer pour créer le lien permanent.</li>
                    <li><b>NOUVEAU - Systèmes Hostiles :</b> Si vous découvrez un système (par sonde ou saut à l'aveugle) où un autre joueur possède au moins une planète, la connexion peut être établie immédiatement après confirmation, sans nécessiter de sondage mutuel.</li>
                </ul>

                <h4>NOUVEAU - Blocus et Conditions d'Exploration</h4>
                <ul>
                    <li>Vous ne pouvez pas explorer <b>DEPUIS</b> un système où un autre joueur possède une ou plusieurs planètes (Blocus).</li>
                    <li>Vous devez contrôler au moins une planète dans un système pour pouvoir explorer <b>DEPUIS</b> celui-ci (sauf pour votre système de départ).</li>
                </ul>


                <h4>Explosion du Warp</h4>
                <p>Le bouton "Explosion du Warp" réinitialise complètement la carte galactique. Tous les systèmes PNJ et toutes les connexions sont détruits. Chaque joueur se voit attribuer un tout nouveau système de départ. Les fiches de joueur (unités, points, etc.) restent intactes.</p>
            </div>
        </div>
    </div>
    
    <div id="notification-container"></div>

    <div id="confirm-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="confirm-modal-title">Confirmation</h3>
            <p id="confirm-modal-text" style="line-height: 1.6;"></p>
            <div class="modal-actions">
                <button id="confirm-modal-cancel-btn" class="btn-secondary">Annuler</button>
                <button id="confirm-modal-ok-btn" class="btn-primary">Confirmer</button>
            </div>
        </div>
    </div>

    <script src="systems.js"></script>
    <script src="script.js"></script>
</body>
</html>